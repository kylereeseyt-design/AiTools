<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>20ä»¥å†…åŠ å‡æ³•ç»ƒä¹ </title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background: #f5f7fb;
      color: #222;
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 0;
      margin: 0;
    }

    .no-overflow {
      overflow: hidden;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 12px 16px 8px;
      width: 100%;
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(15, 35, 95, 0.08);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 1;
      width: 100%;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.03em;
      color: #1a237e;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: #e8eaf6;
      color: #303f9f;
      font-weight: 600;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: #555;
      margin-bottom: 4px;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .status-label {
      color: #888;
    }

    .status-value {
      font-weight: 600;
      color: #1a237e;
      min-width: 44px;
      text-align: right;
    }

    .timer {
      font-feature-settings: "tnum";
    }

    .progress-bar {
      position: relative;
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #e8eaf6;
      overflow: hidden;
      margin-bottom: 4px;
    }

    .progress-inner {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg, #42a5f5, #7e57c2);
      transition: width 0.28s ease-out;
    }

    .question-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 12px 0 16px;
      text-align: center;
      position: relative;
      overflow: hidden;
      width: 100%;
      min-height: 0;
    }
    .question-text {
      font-size: 60px;
      font-weight: 700;
      letter-spacing: 0.06em;
      margin-bottom: 6px;
      color: #1a237e;
    }

    .answer-display {
      height: 42px;
      padding: 6px 14px;
      border-radius: 999px;
      border: 2px solid #c5cae9;
      background: #f8f9ff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      font-weight: 600;
      letter-spacing: 0.12em;
      color: #283593;
      margin-bottom: 10px;
      min-width: 120px;
      line-height: 1;
      box-sizing: border-box;
    }

    .answer-placeholder {
      color: #b0b4d8;
      letter-spacing: 0.06em;
      font-size: 25px;
      line-height: 1;
    }

    .feedback {
      min-height: 22px;
      font-size: 14px;
      font-weight: 600;
    }

    .feedback.correct {
      color: #2e7d32;
    }

    .feedback.wrong {
      color: #c62828;
    }

    .btn-primary {
      width: 100%;
      padding: 14px 10px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #3949ab, #5c6bc0);
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.08em;
      margin-top: 8px;
      box-shadow: 0 6px 14px rgba(57, 73, 171, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 3px 8px rgba(57, 73, 171, 0.35);
    }

    .btn-secondary {
      width: 100%;
      padding: 10px;
      border-radius: 999px;
      border: 1px solid #c5cae9;
      background: #f4f5ff;
      color: #3f51b5;
      font-size: 14px;
      font-weight: 500;
      letter-spacing: 0.08em;
      margin-top: 6px;
    }

    .btn-secondary:active {
      background: #e8eaf6;
    }

    .hidden {
      display: none !important;
    }

    /* å›ºå®šåœ¨é¡µé¢åº•éƒ¨çš„å¼€å§‹æŒ‰é’® */
    .fixed-bottom {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 40px);
      max-width: 440px;
      margin: 0 auto;
      z-index: 1000;
    }
    /* åº•éƒ¨é”®ç›˜ */
    .keyboard-wrapper {
      margin-top: 10px;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 -4px 14px rgba(0, 0, 0, 0.06);
      padding: 10px 10px 8px;
    }

    .keyboard-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .key {
      flex: 1;
      padding: 18px 0;
      border-radius: 9px;
      border: none;
      background: #f3f4ff;
      font-size: 30px;
      font-weight: 600;
      color: #1a237e;
      box-shadow: 0 2px 4px rgba(26, 35, 126, 0.08);
    }

    .key:active {
      background: #e0e3ff;
      transform: translateY(1px);
      box-shadow: 0 1px 2px rgba(26, 35, 126, 0.2);
    }

    .key.function {
      font-size: 15px;
      font-weight: 500;
      background: #e8eaf6;
      color: #3949ab;
    }

    .key.ok {
      background: linear-gradient(135deg, #43a047, #66bb6a);
      color: #fff;
      font-size: 17px;
    }

    .key.ok:active {
      background: linear-gradient(135deg, #388e3c, #43a047);
    }

    /* ç»“æœé¡µ */
    .result-list {
      max-height: 230px;
      overflow-y: auto;
      padding-right: 4px;
      margin-top: 8px;
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      border-radius: 10px;
      margin-bottom: 4px;
      background: #f8f9ff;
      font-size: 13px;
    }

    .result-item.correct {
      border-left: 3px solid #43a047;
    }

    .result-item.wrong {
      border-left: 3px solid #e53935;
    }

    .result-exp {
      font-weight: 600;
      color: #283593;
    }

    .result-ans {
      margin-left: 6px;
      color: #555;
    }

    .result-badge {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      color: #fff;
      background: #43a047;
    }

    .result-badge.wrong {
      background: #e53935;
    }

    .result-summary {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 6px;
      font-size: 13px;
      color: #555;
    }

    .chip {
      flex: 1;
      padding: 8px 10px;
      border-radius: 12px;
      background: #f4f5ff;
    }

    .chip-label {
      font-size: 11px;
      color: #888;
      margin-bottom: 3px;
    }

    .chip-value {
      font-size: 16px;
      font-weight: 700;
      color: #1a237e;
    }

    .highlight {
      color: #ff7043;
      font-weight: 700;
    }

    /* å†å²æˆç»© */
    .history-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e8eaf6;
    }

    .history-title {
      font-size: 14px;
      font-weight: 600;
      color: #1a237e;
      margin-bottom: 8px;
    }

    .top-scores {
      margin-bottom: 12px;
    }

    .top-scores-title {
      font-size: 12px;
      color: #666;
      margin-bottom: 6px;
    }

    .top-score-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      margin-bottom: 4px;
      background: #f8f9ff;
      border-radius: 8px;
      font-size: 12px;
    }

    .top-score-rank {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      color: #1a237e;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      margin-right: 8px;
    }

    .top-score-rank.second {
      background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
    }

    .top-score-rank.third {
      background: linear-gradient(135deg, #cd7f32, #e8a87c);
    }

    .top-score-info {
      flex: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .top-score-detail {
      color: #555;
    }

    .top-score-value {
      font-weight: 600;
      color: #1a237e;
    }

    .all-scores {
      margin-top: 12px;
      margin-bottom: 60px;
    }

    .all-scores-title {
      font-size: 12px;
      color: #666;
      margin-bottom: 6px;
    }

    .score-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      margin-bottom: 4px;
      background: #f8f9ff;
      border-radius: 8px;
      font-size: 12px;
      border-left: 3px solid #c5cae9;
    }

    .score-date {
      color: #888;
      font-size: 11px;
      margin-bottom: 2px;
    }

    .score-details {
      flex: 1;
    }

    .score-row {
      display: flex;
      gap: 8px;
      color: #555;
      margin-top: 2px;
    }

    .score-label {
      color: #888;
    }

    .score-value {
      font-weight: 600;
      color: #1a237e;
    }

    .no-history {
      text-align: center;
      color: #999;
      font-size: 12px;
      padding: 12px;
    }

    /* ä»Šæ—¥å¾½ç«  */
    .badge-section {
      margin-top: 12px;
      margin-bottom: 12px;
      padding-top: 12px;
      border-top: 1px solid #e8eaf6;
    }

    .badge-title {
      font-size: 14px;
      font-weight: 600;
      color: #1a237e;
      margin-bottom: 8px;
    }

    .badge-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 60px;
    }

    .badge-item {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      border: 2px solid #c5cae9;
      background: #f8f9ff;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }

    .badge-item img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 4px;
    }

    .no-badge {
      text-align: center;
      color: #999;
      font-size: 12px;
      padding: 12px;
      width: 100%;
    }

    /* è¿ç»­ç­”å¯¹5é¢˜çš„å¾½ç« å±•ç¤º */
    .badge-celebration {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .badge-celebration img {
      max-width: 70%;
      max-height: 70%;
      object-fit: contain;
      animation: scaleIn 0.5s ease-out;
      border-radius: 8px;
      background: #fff;
      padding: 8px;
    }    @keyframes scaleIn {
      from {
        transform: scale(0.5);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }
    @media (max-height: 620px) {
      .question-text {
        font-size: 34px;
      }
      .answer-display {
        min-height: 36px;
        font-size: 20px;
      }
      .result-list {
        max-height: 190px;
      }
    }
  </style>
</head>
<body id="app-body">
  <div class="app">
    <div class="card" id="start-screen">
      <div class="header">
        <div class="title">20ä»¥å†…åŠ å‡æ³•ç»ƒä¹ </div>
        <div class="badge">å¯è®¾ç½®é™æ—¶</div>
      </div>
      <p style="font-size: 14px; color: #555; line-height: 1.6; margin-bottom: 8px;">
        é€‚åˆåœ¨æ‰‹æœºä¸Šç»ƒä¹ çš„å£ç®—å°æ¸¸æˆã€‚ä½ å¯ä»¥åœ¨é¦–é¡µè®¾ç½®æœ¬å±€çš„é™æ—¶åˆ†é’Ÿæ•°ï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼‰ï¼Œæ¯æ¬¡ç­”å®Œ 1 é¢˜ç«‹åˆ»åˆ¤åˆ†å¹¶æœ‰éŸ³æ•ˆæç¤ºï¼Œç»“æŸåä¼šç»™å‡ºæœ¬æ¬¡æˆç»©å’Œè¯¦ç»†ç­”é¢˜è®°å½•ã€‚
      </p>
      <ul style="font-size: 13px; color: #777; padding-left: 18px; line-height: 1.4;">
        <li>é¢˜ç›®ä¸º 0â€“20 ä»¥å†…çš„åŠ å‡æ³•ï¼Œç»“æœä¹Ÿåœ¨ 0â€“20 èŒƒå›´å†…</li>
        <li>å¼€å§‹åè‡ªåŠ¨å¼€å§‹å€’è®¡æ—¶ï¼Œä¸­é€”ä¸è¦å…³é—­é¡µé¢</li>
        <li>åœ¨é™å®šæ—¶é—´å†…å°½é‡å¤šåšé¢˜ï¼Œç»“æŸåå¯æŸ¥çœ‹ç”¨æ—¶ã€å¾—åˆ†å’Œæ¯ä¸€é¢˜ç»“æœ</li>
      </ul>
      <div style="margin-top: 6px; margin-bottom: 4px; font-size: 13px; color: #555; display: flex; align-items: center; gap: 8px;">
        <span>æœ¬å±€é™æ—¶ï¼š</span>
        <input
          id="limit-minutes"
          type="number"
          min="1"
          max="30"
          value="5"
          style="width: 70px; padding: 6px 8px; border-radius: 999px; border: 1px solid #c5cae9; text-align: center; font-size: 13px; outline: none;"
        />
        <span>åˆ†é’Ÿ</span>
      </div>

      <!-- ä»Šæ—¥å¾½ç« å±•ç¤º -->
      <div class="badge-section" id="badge-section">
        <div class="badge-title">ğŸ… ä»Šæ—¥å¾½ç« </div>
        <div class="badge-container" id="badge-container"></div>
      </div>

      <!-- å†å²æˆç»©å±•ç¤º -->
      <div class="history-section" id="history-section">
        <div class="history-title">ğŸ“Š å†å²æˆç»©</div>
        
        <div class="top-scores">
          <div class="top-scores-title">ğŸ† å‰ 3 å</div>
          <div id="top-scores-list"></div>
        </div>

        <div class="all-scores">
          <div class="all-scores-title">ğŸ“‹ å…¨éƒ¨è®°å½•</div>
          <div id="all-scores-list"></div>
        </div>
      </div>
    </div>
    <div class="card hidden" id="game-screen">
      <div class="header">
        <div class="title" style="font-size: 16px;">ç­”é¢˜ä¸­</div>
        <div class="badge">
          ç¬¬ <span id="current-index">1</span> é¢˜
        </div>
      </div>

      <div class="status-bar">
        <div class="status-item">
          <span class="status-label">å‰©ä½™æ—¶é—´</span>
          <span class="status-value timer" id="timer">00:00</span>
        </div>
        <div class="status-item">
          <span class="status-label">å·²åš / æ­£ç¡®</span>
          <span class="status-value" id="correct-count">0 / 0</span>
        </div>
      </div>

      <div class="progress-bar">
        <div class="progress-inner" id="progress-inner"></div>
      </div>

      <div class="question-area">
        <div class="question-text" id="question-text">
          0 + 0 =
        </div>
        <div class="answer-display" id="answer-display">
          <span class="answer-placeholder">ç‚¹å‡»ä¸‹æ–¹è¾“å…¥ç­”æ¡ˆ</span>
        </div>
        <div class="feedback" id="feedback"></div>
      </div>
    </div>

    <div class="card hidden" id="result-screen">
      <div class="header">
        <div class="title">æœ¬æ¬¡æˆç»©</div>
        <div class="badge" id="result-badge">0 åˆ†</div>
      </div>
      <div class="result-summary">
        <div class="chip">
          <div class="chip-label">æ€»ç”¨æ—¶</div>
          <div class="chip-value" id="result-time">00:00</div>
        </div>
        <div class="chip">
          <div class="chip-label">æ­£ç¡® / æ€»é¢˜æ•°</div>
          <div class="chip-value"><span id="result-correct">0</span> / <span id="result-total">0</span></div>
        </div>
        <div class="chip">
          <div class="chip-label">æ­£ç¡®ç‡</div>
          <div class="chip-value" id="result-rate">0%</div>
        </div>
      </div>

      <div style="margin-top: 10px; font-size: 13px; color: #666; display: flex; align-items: center; gap: 8px;">
        <span id="result-badge-label">æœ¬æ¬¡è·å¾—å¾½ç« ï¼š</span>
        <div id="result-badge-img" style="width: 50px; height: 50px; border-radius: 10px; border: 2px solid #c5cae9; background: #f8f9ff; display: flex; align-items: center; justify-content: center; overflow: hidden;"></div>
      </div>

      <div style="margin-top: 10px; font-size: 13px; color: #666;">
        é¢˜ç›®æ˜ç»†ï¼š
      </div>
      <div class="result-list" id="result-list"></div>

      <button class="btn-primary" id="btn-restart">
        ğŸ” å†æ¥ä¸€å±€
      </button>
      <button class="btn-secondary" id="btn-back">
        è¿”å›å¼€å§‹é¡µé¢
      </button>
    </div>

    <!-- åº•éƒ¨é”®ç›˜ -->
    <div class="keyboard-wrapper hidden" id="keyboard">
      <div class="keyboard-row">
        <button class="key" data-key="1">1</button>
        <button class="key" data-key="2">2</button>
        <button class="key" data-key="3">3</button>
      </div>
      <div class="keyboard-row">
        <button class="key" data-key="4">4</button>
        <button class="key" data-key="5">5</button>
        <button class="key" data-key="6">6</button>
      </div>
      <div class="keyboard-row">
        <button class="key" data-key="7">7</button>
        <button class="key" data-key="8">8</button>
        <button class="key" data-key="9">9</button>
      </div>
      <div class="keyboard-row">
        <button class="key function" data-key="del">åˆ é™¤</button>
        <button class="key" data-key="0">0</button>
        <button class="key function" data-key="neg">Â±</button>
      </div>
      <div class="keyboard-row" style="margin-bottom: 0;">
        <button class="key function" style="flex: 1.2;" data-key="clear">æ¸…ç©º</button>
        <button class="key ok" style="flex: 1.8;" data-key="ok">ç¡®å®š</button>
      </div>
    </div>
  </div>

    <button class="btn-primary fixed-bottom" id="btn-start">
      â–¶ å¼€å§‹æ¸¸æˆ
    </button>

  <script>    (function () {
      const MAX_NUMBER = 20;
      const DEFAULT_MINUTES = 5; // é»˜è®¤ 5 åˆ†é’Ÿ

      const appBody = document.getElementById("app-body");

      const startScreen = document.getElementById("start-screen");
      const gameScreen = document.getElementById("game-screen");
      const resultScreen = document.getElementById("result-screen");
      const keyboard = document.getElementById("keyboard");

      const btnStart = document.getElementById("btn-start");
      const btnRestart = document.getElementById("btn-restart");
      const btnBack = document.getElementById("btn-back");
      const limitMinutesInput = document.getElementById("limit-minutes");

      const currentIndexEl = document.getElementById("current-index");
      const correctCountEl = document.getElementById("correct-count");
      const questionTextEl = document.getElementById("question-text");
      const answerDisplayEl = document.getElementById("answer-display");
      const feedbackEl = document.getElementById("feedback");
      const timerEl = document.getElementById("timer");
      const progressInner = document.getElementById("progress-inner");

      const resultBadgeEl = document.getElementById("result-badge");
      const resultTimeEl = document.getElementById("result-time");
      const resultCorrectEl = document.getElementById("result-correct");
      const resultTotalEl = document.getElementById("result-total");
      const resultRateEl = document.getElementById("result-rate");
      const resultListEl = document.getElementById("result-list");
      const topScoresListEl = document.getElementById("top-scores-list");
      const allScoresListEl = document.getElementById("all-scores-list");
      const badgeContainerEl = document.getElementById("badge-container");

      let questions = [];
      let currentIndex = 0;
      let currentAnswerStr = "";
      let correctCount = 0;
      let answeredCount = 0;
      let consecutiveCorrect = 0; // è¿ç»­ç­”å¯¹è®¡æ•°
      let startTime = 0;
      let timerInterval = null;
      let results = [];
      let gameOver = false;
      let totalTimeSeconds = DEFAULT_MINUTES * 60;

      // æç¤ºéŸ³ï¼šä¼˜å…ˆä½¿ç”¨ä½ æä¾›çš„å¤šé‚»å›½éŸ³æ•ˆæ–‡ä»¶ï¼Œå¤±è´¥æ—¶å†é€€å› Web Audio åˆæˆçŸ­æç¤ºéŸ³
      let audioContext = null;
      let htmlAudioCorrect = null;
      let htmlAudioWrong = null;
      let htmlAudioGreat = null;
      let audioPreloaded = false; // éŸ³é¢‘é¢„åŠ è½½çŠ¶æ€
      
      function initHtmlAudio() {
        if (!htmlAudioCorrect) {
          htmlAudioCorrect = document.getElementById("sound-correct") || null;
        }
        if (!htmlAudioWrong) {
          htmlAudioWrong = document.getElementById("sound-wrong") || null;
        }
        if (!htmlAudioGreat) {
          htmlAudioGreat = document.getElementById("sound-great") || null;
        }
      }

      // é¢„åŠ è½½éŸ³é¢‘æ–‡ä»¶ï¼Œç¡®ä¿æµè§ˆå™¨ç¼“å­˜
      function preloadAudio() {
        if (audioPreloaded) return;
        
        initHtmlAudio();
        const audioFiles = [
          { element: htmlAudioCorrect, name: 'correct' },
          { element: htmlAudioWrong, name: 'wrong' },
          { element: htmlAudioGreat, name: 'great' }
        ];

        let loadedCount = 0;
        const totalCount = audioFiles.filter(a => a.element).length;

        audioFiles.forEach(({ element, name }) => {
          if (!element) return;

          // è®¾ç½®é¢„åŠ è½½å±æ€§
          element.preload = 'auto';
          
          // å¼ºåˆ¶åŠ è½½éŸ³é¢‘
          try {
            // æ–¹æ³•1: è°ƒç”¨ load() æ–¹æ³•å¼ºåˆ¶æµè§ˆå™¨ä¸‹è½½
            element.load();
            
            // æ–¹æ³•2: å°è¯•æ’­æ”¾ä¸€å°æ®µç„¶åç«‹å³æš‚åœï¼Œå¼ºåˆ¶æµè§ˆå™¨ç¼“å­˜
            // æ³¨æ„ï¼šç°ä»£æµè§ˆå™¨å¯èƒ½é˜»æ­¢è‡ªåŠ¨æ’­æ”¾ï¼Œæ‰€ä»¥ä½¿ç”¨ canplaythrough äº‹ä»¶
            const handleCanPlay = () => {
              loadedCount++;
              // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
              element.removeEventListener('canplaythrough', handleCanPlay);
              element.removeEventListener('error', handleError);
              
              if (loadedCount >= totalCount) {
                audioPreloaded = true;
                console.log('æ‰€æœ‰éŸ³é¢‘æ–‡ä»¶å·²é¢„åŠ è½½å®Œæˆ');
              }
            };
            
            const handleError = (e) => {
              console.warn(`éŸ³é¢‘æ–‡ä»¶ ${name} åŠ è½½å¤±è´¥:`, e);
              loadedCount++;
              element.removeEventListener('canplaythrough', handleCanPlay);
              element.removeEventListener('error', handleError);
              
              if (loadedCount >= totalCount) {
                audioPreloaded = true;
              }
            };

            // ç›‘å¬åŠ è½½å®Œæˆäº‹ä»¶
            element.addEventListener('canplaythrough', handleCanPlay, { once: true });
            element.addEventListener('error', handleError, { once: true });
            
            // å¦‚æœå·²ç»å¯ä»¥æ’­æ”¾ï¼Œç›´æ¥è§¦å‘
            if (element.readyState >= 3) { // HAVE_FUTURE_DATA æˆ–æ›´é«˜
              handleCanPlay();
            }
          } catch (e) {
            console.warn(`é¢„åŠ è½½éŸ³é¢‘ ${name} æ—¶å‡ºé”™:`, e);
            loadedCount++;
            if (loadedCount >= totalCount) {
              audioPreloaded = true;
            }
          }
        });

        // å¦‚æœæ²¡æœ‰éŸ³é¢‘æ–‡ä»¶ï¼Œç›´æ¥æ ‡è®°ä¸ºå·²åŠ è½½
        if (totalCount === 0) {
          audioPreloaded = true;
        }
      }

      function playBeep(success, useGreat = false) {
        initHtmlAudio();

        // å¦‚æœè¿ç»­ç­”å¯¹5é¢˜ï¼Œæ’­æ”¾ great.mp3
        if (success && useGreat) {
          try {
            if (htmlAudioGreat) {
              htmlAudioGreat.currentTime = 0;
              const playPromise = htmlAudioGreat.play();
              if (playPromise && typeof playPromise.then === "function") {
                playPromise.catch(() => {
                  // å¦‚æœæ’­æ”¾å¤±è´¥ï¼Œä½¿ç”¨æ™®é€šæ­£ç¡®éŸ³æ•ˆ
                  playBeep(success, false);
                });
              }
              return;
            }
          } catch (e) {
            // å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œä½¿ç”¨æ™®é€šæ­£ç¡®éŸ³æ•ˆ
            playBeep(success, false);
          }
        }

        // 1. ä¼˜å…ˆå°è¯•æ’­æ”¾å¤–éƒ¨éŸ³æ•ˆæ–‡ä»¶ï¼ˆä½ å¯ä»¥åœ¨åŒç›®å½•æ”¾å¤šé‚»å›½çš„"åšå¯¹/åšé”™"éŸ³æ•ˆ mp3ï¼‰
        try {
          const audioEl = success ? htmlAudioCorrect : htmlAudioWrong;
          if (audioEl) {
            audioEl.currentTime = 0;
            const playPromise = audioEl.play();
            if (playPromise && typeof playPromise.then === "function") {
              playPromise.catch(() => {
                // å¦‚æœè‡ªåŠ¨æ’­æ”¾è¢«æµè§ˆå™¨é˜»æ­¢ï¼Œåˆ™é™é»˜å¤±è´¥ï¼Œåé¢ç”¨ Web Audio å…œåº•
                playWithWebAudioFallback(success);
              });
            }
            return;
          }
        } catch (e) {
          // å¤–éƒ¨éŸ³é¢‘å¤±è´¥åˆ™ç»§ç»­ç”¨ Web Audio
        }

        // 2. å…œåº•ï¼šä½¿ç”¨ Web Audio API ç”Ÿæˆç®€å•"å“”"å£°
        playWithWebAudioFallback(success);
      }

      function playWithWebAudioFallback(success) {
        try {
          const AudioCtx = window.AudioContext || window.webkitAudioContext;
          if (!AudioCtx) return;
          if (!audioContext) {
            audioContext = new AudioCtx();
          }
          const duration = success ? 0.13 : 0.18;
          const frequency = success ? 880 : 220;

          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          oscillator.type = "sine";
          oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);

          gainNode.gain.setValueAtTime(0.001, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.35, audioContext.currentTime + 0.02);
          gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);

          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);

          oscillator.start();
          oscillator.stop(audioContext.currentTime + duration + 0.02);
        } catch (e) {
          // å®‰é™å¤±è´¥å³å¯
        }
      }

      function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return (m < 10 ? "0" + m : "" + m) + ":" + (s < 10 ? "0" + s : "" + s);
      }

      function startTimer() {
        startTime = Date.now();
        clearInterval(timerInterval);
        gameOver = false;
        timerInterval = setInterval(() => {
          const elapsed = (Date.now() - startTime) / 1000;
          let remain = totalTimeSeconds - elapsed;
          if (remain < 0) remain = 0;
          timerEl.textContent = formatTime(remain);

          const progress = ((totalTimeSeconds - remain) / totalTimeSeconds) * 100;
          progressInner.style.width = progress.toFixed(1) + "%";

          if (remain <= 0 && !gameOver) {
            finishGame(totalTimeSeconds);
          }
        }, 250);
      }

      function stopTimer() {
        clearInterval(timerInterval);
        timerInterval = null;
      }

      // ç”Ÿæˆå•ä¸ªé¢˜ç›®ï¼Œä¿è¯åœ¨ 0â€“20 èŒƒå›´å†…
      function generateQuestion() {
        const isAdd = Math.random() < 0.5;
        let a, b, op, ans;
        if (isAdd) {
          a = Math.floor(Math.random() * (MAX_NUMBER + 1)); // 0-20
          b = Math.floor(Math.random() * (MAX_NUMBER + 1));
          // æ§åˆ¶ç»“æœä¸è¶…è¿‡ 20
          if (a + b > MAX_NUMBER) {
            const sum = a + b;
            const overflow = sum - MAX_NUMBER;
            // å°½é‡å‡å° b
            b = Math.max(0, b - overflow);
          }
          op = "+";
          ans = a + b;
        } else {
          a = Math.floor(Math.random() * (MAX_NUMBER + 1));
          b = Math.floor(Math.random() * (MAX_NUMBER + 1));
          if (b > a) {
            // ç¡®ä¿ä¸å‡ºç°è´Ÿæ•°
            [a, b] = [b, a];
          }
          op = "-";
          ans = a - b;
        }
        return { a, b, op, ans };
      }

      function ensureNextQuestion() {
        if (currentIndex >= questions.length) {
          questions.push(generateQuestion());
        }
      }

      function showScreen(name) {
        appBody.classList.remove("no-overflow");
        startScreen.classList.add("hidden");
        gameScreen.classList.add("hidden");
        resultScreen.classList.add("hidden");
        keyboard.classList.add("hidden");
        const startButton = document.getElementById("btn-start");
        
        if (name === "start") {
          startScreen.classList.remove("hidden");
          if (startButton) {
            startButton.style.display = "block";
          }
          renderHistory(); // è¿”å›é¦–é¡µæ—¶åˆ·æ–°å†å²æˆç»©
        } else if (name === "game") {
          gameScreen.classList.remove("hidden");
          appBody.classList.add("no-overflow");
          keyboard.classList.remove("hidden");
          if (startButton) {
            startButton.style.display = "none";
          }
        } else if (name === "result") {
          resultScreen.classList.remove("hidden");
          if (startButton) {
            startButton.style.display = "none";
          }
        }
      }
      function renderQuestion() {
        ensureNextQuestion();
        const q = questions[currentIndex];
        questionTextEl.textContent = q.a + " " + q.op + " " + q.b + " =";
        answerDisplayEl.innerHTML = '<span class="answer-placeholder">ç‚¹å‡»ä¸‹æ–¹è¾“å…¥ç­”æ¡ˆ</span>';
        feedbackEl.textContent = "";
        feedbackEl.className = "feedback";

        currentIndexEl.textContent = currentIndex + 1;
        correctCountEl.textContent = answeredCount + " / " + correctCount;
        currentAnswerStr = "";
      }

      function updateAnswerDisplay() {
        if (!currentAnswerStr) {
          answerDisplayEl.innerHTML = '<span class="answer-placeholder">ç‚¹å‡»ä¸‹æ–¹è¾“å…¥ç­”æ¡ˆ</span>';
        } else {
          answerDisplayEl.innerHTML = '<span>' + currentAnswerStr + '</span>';
        }
      }

      function handleSubmitAnswer() {
        if (gameOver) return;
        if (!questions[currentIndex]) return;
        if (!currentAnswerStr || currentAnswerStr === "-") {
          feedbackEl.textContent = "è¯·å…ˆè¾“å…¥ç­”æ¡ˆ";
          feedbackEl.className = "feedback wrong";
          return;
        }

        const userAns = parseInt(currentAnswerStr, 10);
        const q = questions[currentIndex];
        const isCorrect = userAns === q.ans;
        
        let shouldShowCelebration = false;
        
        if (isCorrect) {
          correctCount++;
          consecutiveCorrect++; // å¢åŠ è¿ç»­ç­”å¯¹è®¡æ•°
          correctCountEl.textContent = answeredCount + " / " + correctCount;
          feedbackEl.textContent = "âˆš å›ç­”æ­£ç¡®ï¼";
          feedbackEl.className = "feedback correct";
          
          // æ£€æŸ¥æ˜¯å¦è¿ç»­ç­”å¯¹5é¢˜
          if (consecutiveCorrect >= 5) {
            shouldShowCelebration = true;
            consecutiveCorrect = 0; // é‡ç½®è®¡æ•°ï¼Œé¿å…é‡å¤è§¦å‘
            playBeep(true, true); // æ’­æ”¾ great.mp3
            if (!gameOver) {
                renderQuestion();
            }
            // showBadgeCelebration(() => {
            //   // å¾½ç« å±•ç¤ºå®Œæˆåçš„å›è°ƒ
            //   if (!gameOver) {
            //     renderQuestion();
            //   }
            // });
          } else {
            playBeep(true, false); // æ’­æ”¾æ™®é€šæ­£ç¡®éŸ³æ•ˆ
          }
        } else {
          consecutiveCorrect = 0; // ç­”é”™æ—¶é‡ç½®è¿ç»­ç­”å¯¹è®¡æ•°
          feedbackEl.textContent = "âœ— å›ç­”é”™è¯¯ï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯ " + q.ans;
          feedbackEl.className = "feedback wrong";
          playBeep(false);
        }

        const usedSeconds = (Date.now() - startTime) / 1000;

        results.push({
          index: currentIndex + 1,
          a: q.a,
          b: q.b,
          op: q.op,
          correctAnswer: q.ans,
          userAnswer: userAns,
          isCorrect
        });
        answeredCount++;
        correctCountEl.textContent = answeredCount + " / " + correctCount;
        currentIndex++;

        // å¦‚æœå±•ç¤ºäº†å¾½ç« åº†ç¥ï¼Œå°±ä¸åœ¨è¿™é‡Œè¿›å…¥ä¸‹ä¸€é¢˜ï¼ˆç”±åº†ç¥åŠ¨ç”»çš„å›è°ƒå¤„ç†ï¼‰
        if (!shouldShowCelebration) {
          setTimeout(() => {
            if (!gameOver) {
              renderQuestion();
            }
          }, 420);
        }
      }

      // è·å–éšæœºå¾½ç« ï¼ˆä» imgs æ–‡ä»¶å¤¹ï¼‰
      // æ³¨æ„ï¼šç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæ— æ³•ç›´æ¥è¯»å–æ–‡ä»¶å¤¹ï¼Œæ‰€ä»¥éœ€è¦é¢„å®šä¹‰å›¾ç‰‡åˆ—è¡¨
      // è¯·æ ¹æ®ä½ çš„ imgs æ–‡ä»¶å¤¹ä¸­çš„å®é™…å›¾ç‰‡æ–‡ä»¶åä¿®æ”¹ä¸‹é¢çš„ badgeList æ•°ç»„
      function getRandomBadge() {
        // é¢„å®šä¹‰çš„å¾½ç« å›¾ç‰‡åˆ—è¡¨ï¼ˆè¯·æ ¹æ®ä½ çš„ imgs æ–‡ä»¶å¤¹ä¸­çš„å®é™…æ–‡ä»¶åä¿®æ”¹ï¼‰
        // ä¾‹å¦‚ï¼šå¦‚æœ imgs æ–‡ä»¶å¤¹æœ‰ star.png, moon.png, sun.png ç­‰ï¼Œå°±æ”¹æˆï¼š
        // const badgeList = ["star.png", "moon.png", "sun.png"];
        const badgeList = [
          "labubu_01.png", "labubu_02.png", "labubu_03.png", "labubu_04.png", "labubu_05.png",
          "labubu_06.png", "labubu_07.png", "labubu_08.png", "labubu_09.png", "labubu_10.png",
          "labubu_11.png", "labubu_12.png", "labubu_13.png", "labubu_14.png", "labubu_15.png",
          "labubu_16.png", "labubu_17.png", "labubu_18.png", "labubu_19.png", "labubu_20.png"
        ];
        
        // å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œè¿”å›é»˜è®¤å€¼
        if (badgeList.length === 0) {
          return "default.png";
        }
        
        // éšæœºé€‰æ‹©ä¸€ä¸ª
        const randomIndex = Math.floor(Math.random() * badgeList.length);
        return badgeList[randomIndex];
      }

      // å±•ç¤ºè¿ç»­ç­”å¯¹5é¢˜çš„å¾½ç« åº†ç¥åŠ¨ç”»
      function showBadgeCelebration(callback) {
        const badgeName = getRandomBadge();
        const celebrationDiv = document.createElement("div");
        celebrationDiv.className = "badge-celebration";
        celebrationDiv.id = "badge-celebration";
        
        const img = document.createElement("img");
        img.src = "imgs/" + badgeName;
        img.alt = badgeName;
        img.onerror = function() {
          // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºæ–‡å­—
          celebrationDiv.innerHTML = '<div style="color: #fff; font-size: 24px; font-weight: 700; text-align: center;">ğŸ‰ è¿ç»­ç­”å¯¹5é¢˜ï¼</div>';
        };
        
        celebrationDiv.appendChild(img);
        // å°†å¾½ç« åº†ç¥åŠ¨ç”»æ·»åŠ åˆ°é¢˜ç›®åŒºåŸŸè€Œä¸æ˜¯æ•´ä¸ªé¡µé¢
        const questionArea = document.querySelector('.question-area');
        if (questionArea) {
          questionArea.appendChild(celebrationDiv);
        } else {
          document.body.appendChild(celebrationDiv);
        }
        
        // 1.5ç§’åç§»é™¤å¹¶æ‰§è¡Œå›è°ƒ
        setTimeout(() => {
          if (celebrationDiv.parentNode) {
            celebrationDiv.parentNode.removeChild(celebrationDiv);
          }
          if (callback) {
            callback();
          }
        }, 1500);
      }
      // ä¿å­˜æˆç»©åˆ°æœ¬åœ°å­˜å‚¨
      function saveScore(correct, total, timeLimitMinutes, badgeName) {
        try {
          const scoreData = {
            date: new Date().toISOString(),
            dateStr: new Date().toLocaleString("zh-CN", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit"
            }),
            timeLimit: timeLimitMinutes,
            total: total,
            correct: correct,
            wrong: total - correct,
            rate: total > 0 ? ((correct / total) * 100).toFixed(1) : 0,
            badge: badgeName
          };

          let allScores = [];
          const stored = localStorage.getItem("mathGameScores");
          if (stored) {
            try {
              allScores = JSON.parse(stored);
            } catch (e) {
              allScores = [];
            }
          }

          allScores.push(scoreData);
          localStorage.setItem("mathGameScores", JSON.stringify(allScores));
        } catch (e) {
          console.error("ä¿å­˜æˆç»©å¤±è´¥:", e);
        }
      }

      // è¯»å–å†å²æˆç»©
      function loadScores() {
        try {
          const stored = localStorage.getItem("mathGameScores");
          if (!stored) return [];
          return JSON.parse(stored);
        } catch (e) {
          return [];
        }
      }

      // æ¸²æŸ“ä»Šæ—¥å¾½ç« 
      function renderTodayBadges() {
        if (!badgeContainerEl) return;
        
        badgeContainerEl.innerHTML = "";
        
        const allScores = loadScores();
        if (allScores.length === 0) {
          badgeContainerEl.innerHTML = '<div class="no-badge">ä»Šæ—¥æš‚æ— å¾½ç« </div>';
          return;
        }
        
        // è·å–ä»Šå¤©çš„æ—¥æœŸï¼ˆåªæ¯”è¾ƒå¹´æœˆæ—¥ï¼‰
        const today = new Date();
        const todayStr = today.toISOString().split("T")[0]; // YYYY-MM-DD
        
        // ç­›é€‰å‡ºä»Šå¤©çš„æˆç»©
        const todayScores = allScores.filter(score => {
          const scoreDate = new Date(score.date);
          const scoreDateStr = scoreDate.toISOString().split("T")[0];
          return scoreDateStr === todayStr;
        });
        
        if (todayScores.length === 0) {
          badgeContainerEl.innerHTML = '<div class="no-badge">ä»Šæ—¥æš‚æ— å¾½ç« </div>';
          return;
        }
        
        // è·å–ä»Šå¤©è·å¾—çš„å¾½ç« ï¼ˆå»é‡ï¼‰
        const todayBadges = [];
        const badgeSet = new Set();
        todayScores.forEach(score => {
          if (score.badge && !badgeSet.has(score.badge)) {
            badgeSet.add(score.badge);
            todayBadges.push(score.badge);
          }
        });
        
        if (todayBadges.length === 0) {
          badgeContainerEl.innerHTML = '<div class="no-badge">ä»Šæ—¥æš‚æ— å¾½ç« </div>';
          return;
        }
        
        // å±•ç¤ºå¾½ç« 
        todayBadges.forEach(badgeName => {
          const div = document.createElement("div");
          div.className = "badge-item";
          const img = document.createElement("img");
          img.src = "imgs/" + badgeName;
          img.alt = badgeName;
          img.onerror = function() {
            // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºå ä½ç¬¦
            this.style.display = "none";
            div.innerHTML = '<div style="font-size: 10px; color: #999;">' + badgeName + "</div>";
          };
          div.appendChild(img);
          badgeContainerEl.appendChild(div);
        });
      }

      // å±•ç¤ºå†å²æˆç»©
      function renderHistory() {
        const allScores = loadScores();
        
        // æ¸…ç©ºåˆ—è¡¨
        if (topScoresListEl) topScoresListEl.innerHTML = "";
        if (allScoresListEl) allScoresListEl.innerHTML = "";

        if (allScores.length === 0) {
          if (topScoresListEl) {
            topScoresListEl.innerHTML = '<div class="no-history">æš‚æ— è®°å½•</div>';
          }
          if (allScoresListEl) {
            allScoresListEl.innerHTML = '<div class="no-history">æš‚æ— è®°å½•</div>';
          }
          renderTodayBadges(); // å³ä½¿æ²¡æœ‰å†å²è®°å½•ä¹Ÿè¦æ¸²æŸ“ä»Šæ—¥å¾½ç« 
          return;
        }

        // æ’åºï¼šå‰3åæŒ‰ç­”é¢˜æ•°ï¼ˆé™åºï¼‰ï¼Œç›¸åŒåˆ™æŒ‰æ­£ç¡®ç‡ï¼ˆé™åºï¼‰
        const sortedForTop = [...allScores].sort((a, b) => {
          if (b.total !== a.total) {
            return b.total - a.total;
          }
          return parseFloat(b.rate) - parseFloat(a.rate);
        });
        const top3 = sortedForTop.slice(0, 3);

        // å±•ç¤ºå‰3å
        if (topScoresListEl) {
          top3.forEach((score, idx) => {
            const div = document.createElement("div");
            div.className = "top-score-item";
            const rankClass = idx === 0 ? "" : idx === 1 ? "second" : "third";
            const rankText = idx === 0 ? "ğŸ¥‡" : idx === 1 ? "ğŸ¥ˆ" : "ğŸ¥‰";
            div.innerHTML =
              '<div class="top-score-rank ' + rankClass + '">' + rankText + "</div>" +
              '<div class="top-score-info">' +
              '<div class="top-score-detail">' + score.timeLimit + " åˆ†é’Ÿï¼Œ" + score.correct + ' / <span class="score-value">' + score.total + "</span> é¢˜ï¼Œæ­£ç¡®ç‡ " + score.rate + "%ï¼ˆ"+ score.dateStr  +"ï¼‰</div>" +
              //'<div class="top-score-value">' + score.correct + " / " + score.total + "</div>" +
              "</div>";
            topScoresListEl.appendChild(div);
          });
        }

        // å…¨éƒ¨è®°å½•æŒ‰æ—¶é—´å€’åº
        const sortedByTime = [...allScores].sort((a, b) => {
          return new Date(b.date) - new Date(a.date);
        });

        // å±•ç¤ºå…¨éƒ¨è®°å½•
        if (allScoresListEl) {
          sortedByTime.forEach((score) => {
            const div = document.createElement("div");
            div.className = "score-item";
            div.innerHTML =
              '<div class="score-details">' +
              '<div class="score-date">' + score.dateStr + 
              '<span class="score-label" style="margin-left: 12px;">é™æ—¶ï¼š' + score.timeLimit + " åˆ†é’Ÿ</span>" +
              "</div>" +
              '<div class="score-row">' +
              '<span class="score-label">ç­”é¢˜æ•°ï¼š</span><span class="score-value">' + score.total + "</span>" +
              '<span class="score-label" style="margin-left: 12px;">é”™è¯¯æ•°ï¼š</span><span class="score-value">' + score.wrong + "</span>" +
              '<span class="score-label" style="margin-left: 12px;">æ­£ç¡®ç‡ï¼š</span><span class="score-value">' + score.rate + "%</span>" +
              "</div>" +
              "</div>";
            allScoresListEl.appendChild(div);
          });
        }
        
        // æ¸²æŸ“ä»Šæ—¥å¾½ç« 
        renderTodayBadges();
      }

      function finishGame(totalSeconds) {
        if (gameOver) return;
        gameOver = true;
        stopTimer();

        // ç»Ÿè®¡ç»“æœ
        const correct = correctCount;
        const total = answeredCount;
        const score = total > 0 ? Math.round((correct / total) * 100) : 0;
        const rate = total > 0 ? ((correct / total) * 100).toFixed(0) + "%" : "0%";

        resultCorrectEl.textContent = String(correct);
        resultTotalEl.textContent = String(total);
        resultRateEl.textContent = rate;
        // å®é™…ç”¨æ—¶ = å·²è¿‡æ—¶é—´ï¼Œæœ€å¤šä¸è¶…è¿‡è®¾ç½®çš„æ€»æ—¶é•¿
        const elapsedSeconds = Math.min((Date.now() - startTime) / 1000, totalTimeSeconds);
        resultTimeEl.textContent = formatTime(elapsedSeconds);
        resultBadgeEl.textContent = score + " åˆ†";

        if (score >= 90) {
          resultBadgeEl.style.background = "#43a047";
        } else if (score >= 60) {
          resultBadgeEl.style.background = "#fb8c00";
        } else {
          resultBadgeEl.style.background = "#e53935";
        }

        // è®¡ç®—å¹³å‡æ¯åˆ†é’Ÿåšé¢˜æ•°å’Œæ€»æ­£ç¡®ç‡ï¼Œåˆ¤æ–­æ˜¯å¦æ»¡è¶³å¾½ç« æ¡ä»¶
        const timeLimitMinutes = Math.round(totalTimeSeconds / 60);
        const elapsedMinutes = elapsedSeconds / 60; // å®é™…ç”¨æ—¶ï¼ˆåˆ†é’Ÿï¼‰
        const questionsPerMinute = elapsedMinutes > 0 ? total / elapsedMinutes : 0; // å¹³å‡æ¯åˆ†é’Ÿåšé¢˜æ•°
        const accuracyRate = total > 0 ? (correct / total) * 100 : 0; // æ€»æ­£ç¡®ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
        
        // åˆ¤æ–­æ˜¯å¦æ»¡è¶³å¾½ç« æ¡ä»¶ï¼šå¹³å‡æ¯åˆ†é’Ÿåšé¢˜æ•° > 5 ä¸” æ€»æ­£ç¡®ç‡ > 80%
        const shouldGiveBadge = questionsPerMinute > 5 && accuracyRate > 80;
        
        // æ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦ç»™å¾½ç« 
        const badgeName = shouldGiveBadge ? getRandomBadge() : null;
        saveScore(correct, total, timeLimitMinutes, badgeName);

        // åœ¨ç»“æœé¡µæ˜¾ç¤ºæœ¬æ¬¡è·å¾—çš„å¾½ç« æˆ–æç¤ºä¿¡æ¯
        const resultBadgeImgEl = document.getElementById("result-badge-img");
        const resultBadgeLabelEl = document.getElementById("result-badge-label");
        if (resultBadgeImgEl) {
          resultBadgeImgEl.innerHTML = "";
          if (badgeName) {
            // æ»¡è¶³æ¡ä»¶ï¼Œæ˜¾ç¤ºå¾½ç« 
            if (resultBadgeLabelEl) {
              resultBadgeLabelEl.textContent = "æœ¬æ¬¡è·å¾—å¾½ç« ï¼š";
            }
            const img = document.createElement("img");
            img.src = "imgs/" + badgeName;
            img.alt = badgeName;
            img.style.width = "100%";
            img.style.height = "100%";
            img.style.objectFit = "contain";
            img.style.padding = "4px";
            img.onerror = function() {
              resultBadgeImgEl.innerHTML = '<div style="font-size: 10px; color: #999; text-align: center; padding: 4px;">' + badgeName + "</div>";
            };
            resultBadgeImgEl.appendChild(img);
          } else {
            // ä¸æ»¡è¶³æ¡ä»¶ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            if (resultBadgeLabelEl) {
              resultBadgeLabelEl.textContent = "å¾ˆé—æ†¾ï¼æœ¬æ¬¡æœªè·å¾—å¾½ç« ï¼Œå†æ¥å†å‰ï¼";
            }
            //resultBadgeImgEl.innerHTML = '<div style="font-size: 11px; color: #999; text-align: center; padding: 8px; line-height: 1.4;">éœ€æ»¡è¶³ï¼š<br/>æ¯åˆ†é’Ÿ>5é¢˜<br/>ä¸”æ­£ç¡®ç‡>80%</div>';
          }
        }

        // ç”Ÿæˆè¯¦æƒ…åˆ—è¡¨
        resultListEl.innerHTML = "";
        results.forEach((item) => {
          const div = document.createElement("div");
          div.className = "result-item " + (item.isCorrect ? "correct" : "wrong");
          const exp = item.a + " " + item.op + " " + item.b + " = " + item.correctAnswer;
          const your = item.userAnswer;
          div.innerHTML =
            '<div>' +
            '<span class="result-exp">ç¬¬ ' + item.index + " é¢˜ï¼š" + exp + "</span>" +
            '<span class="result-ans">ä½ çš„ç­”æ¡ˆï¼š<span class="' + (item.isCorrect ? "highlight" : "") + '">' + your + "</span></span>" +
            "</div>" +
            '<div class="result-badge ' + (item.isCorrect ? "" : "wrong") + '">' +
            (item.isCorrect ? "âœ” æ­£ç¡®" : "âœ— é”™è¯¯") +
            "</div>";
          resultListEl.appendChild(div);
        });

        progressInner.style.width = "100%";
        showScreen("result");
      }

      function resetGame() {
        // è¯»å–é¦–é¡µè¾“å…¥çš„åˆ†é’Ÿæ•°
        let minutes = DEFAULT_MINUTES;
        if (limitMinutesInput && limitMinutesInput.value !== "") {
          const num = parseInt(limitMinutesInput.value, 10);
          if (!isNaN(num)) {
            minutes = Math.min(Math.max(num, 1), 30); // é™åˆ¶åœ¨ 1-30 åˆ†é’Ÿ
          }
        }
        totalTimeSeconds = minutes * 60;
        if (limitMinutesInput) {
          limitMinutesInput.value = String(minutes);
        }

        currentIndex = 0;
        correctCount = 0;
        answeredCount = 0;
        consecutiveCorrect = 0; // é‡ç½®è¿ç»­ç­”å¯¹è®¡æ•°
        correctCountEl.textContent = "0 / 0";
        results = [];
        timerEl.textContent = "00:00";
        progressInner.style.width = "0%";
        questions = [];
        renderQuestion();
        startTimer();
        showScreen("game");
      }

      // äº‹ä»¶ç»‘å®š
      btnStart.addEventListener("click", () => {
        resetGame();
      });

      btnRestart.addEventListener("click", () => {
        resetGame();
      });

      btnBack.addEventListener("click", () => {
        stopTimer();
        showScreen("start");
      });

      // æ’­æ”¾æŒ‰é”®éŸ³æ•ˆ
      function playKeyPressSound() {
        // ä½¿ç”¨ Web Audio API ç”Ÿæˆè½»å¿«çš„æŒ‰é”®éŸ³æ•ˆ
        try {
          const AudioCtx = window.AudioContext || window.webkitAudioContext;
          if (!AudioCtx) return;
          
          const audioCtx = new AudioCtx();
          const oscillator = audioCtx.createOscillator();
          const gainNode = audioCtx.createGain();
          
          // è®¾ç½®éŸ³è°ƒå’ŒæŒç»­æ—¶é—´
          oscillator.type = "sine";
          oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
          
          // è®¾ç½®éŸ³é‡åŒ…ç»œ
          gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
          gainNode.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + 0.01);
          gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
          
          oscillator.connect(gainNode);
          gainNode.connect(audioCtx.destination);
          
          oscillator.start();
          oscillator.stop(audioCtx.currentTime + 0.1);
        } catch (e) {
          // é™é»˜å¤±è´¥
        }
      }

      keyboard.addEventListener("click", (e) => {
        const target = e.target;
        if (!(target instanceof HTMLElement)) return;
        const key = target.getAttribute("data-key");
        if (!key) return;

        // æ’­æ”¾æŒ‰é”®éŸ³æ•ˆ
        if (key != "ok") {
          playKeyPressSound();
        }

        if (key === "del") {
          if (currentAnswerStr.length > 0) {
            currentAnswerStr = currentAnswerStr.slice(0, -1);
            updateAnswerDisplay();
          }
          return;
        }

        if (key === "clear") {
          currentAnswerStr = "";
          updateAnswerDisplay();
          return;
        }

        if (key === "neg") {
          if (!currentAnswerStr) {
            currentAnswerStr = "-";
          } else if (currentAnswerStr === "-") {
            currentAnswerStr = "";
          } else if (currentAnswerStr.startsWith("-")) {
            currentAnswerStr = currentAnswerStr.slice(1);
          } else {
            currentAnswerStr = "-" + currentAnswerStr;
          }
          updateAnswerDisplay();
          return;
        }

        if (key === "ok") {
          handleSubmitAnswer();
          return;
        }

        // æ•°å­—é”®
        if (/^\d$/.test(key)) {
          // é™åˆ¶é•¿åº¦ï¼Œæœ€å¤š 3 ä½ï¼ˆæ”¯æŒè´Ÿæ•° -10 ï½ -20 è™½ç„¶æ¸¸æˆé‡Œä¸ä¼šç”¨åˆ°ï¼‰
          const pure = currentAnswerStr.replace("-", "");
          if (pure.length >= 2) return;
          if (currentAnswerStr === "0" && key === "0") return;
          if (currentAnswerStr === "0" && key !== "0") {
            currentAnswerStr = key;
          } else {
            currentAnswerStr += key;
          }
          updateAnswerDisplay();
        }
      });

      // åˆå§‹åŒ–æ˜¾ç¤º
      showScreen("start");
      renderHistory(); // åˆå§‹åŒ–æ—¶æ˜¾ç¤ºå†å²æˆç»©
      
      // é¡µé¢åŠ è½½å®Œæˆåç«‹å³é¢„åŠ è½½éŸ³é¢‘
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', preloadAudio);
      } else {
        // DOM å·²ç»åŠ è½½å®Œæˆï¼Œç«‹å³é¢„åŠ è½½
        preloadAudio();
      }
      
      // é¢å¤–ä¿é™©ï¼šåœ¨ç”¨æˆ·é¦–æ¬¡äº¤äº’æ—¶ä¹Ÿå°è¯•é¢„åŠ è½½ï¼ˆæŸäº›æµè§ˆå™¨éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½åŠ è½½éŸ³é¢‘ï¼‰
      let userInteracted = false;
      const handleUserInteraction = () => {
        if (!userInteracted) {
          userInteracted = true;
          preloadAudio();
          // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
          document.removeEventListener('click', handleUserInteraction);
          document.removeEventListener('touchstart', handleUserInteraction);
        }
      };
      document.addEventListener('click', handleUserInteraction, { once: true });
      document.addEventListener('touchstart', handleUserInteraction, { once: true });
    })();
  </script>
  <!--
    æç¤ºéŸ³éŸ³é¢‘æ–‡ä»¶ï¼ˆå¯è‡ªè¡Œæ›¿æ¢ä¸ºå¤šé‚»å›½ APP å¯¼å‡ºçš„åšå¯¹ / åšé”™éŸ³æ•ˆ mp3ï¼‰ã€‚
    ä½¿ç”¨æ–¹æ³•ï¼š
      1. æŠŠæ­£ç¡®æç¤ºéŸ³æ–‡ä»¶å‘½åä¸º correct.mp3ï¼Œæ”¾åœ¨å’Œæœ¬æ–‡ä»¶åŒä¸€ç›®å½•ï¼›
      2. æŠŠé”™è¯¯æç¤ºéŸ³æ–‡ä»¶å‘½åä¸º wrong.mp3ï¼Œæ”¾åœ¨å’Œæœ¬æ–‡ä»¶åŒä¸€ç›®å½•ï¼›
      3. å¦‚æ–‡ä»¶åä¸åŒï¼Œä¿®æ”¹ä¸‹é¢ audio æ ‡ç­¾ä¸­çš„ src å³å¯ã€‚
  -->
  <audio id="sound-correct" src="sounds/correct.mp3" preload="auto"></audio>
  <audio id="sound-wrong" src="sounds/wrong.mp3" preload="auto"></audio>
  <audio id="sound-great" src="sounds/great.mp3" preload="auto"></audio>
</body>
</html>


